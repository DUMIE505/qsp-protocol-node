files:
  "/tmp/copy-keystore.sh":
    group: root
    mode: "000744"
    owner: root
    content: |
      #!/bin/sh
      env=`{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "QSP_ENV", "DefaultValue": ""}}`
      node_type=`{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "QSP_NODE_TYPE", "DefaultValue": ""}}`
      TABLE_NAME="qsp-protocol-$node_type-$env-keystore"
      rm -f outputfile.txt
      i=0
      aws lambda invoke --region us-east-1 --function-name qsp-protocol-node-keystore --payload "{\"assign\": true, \"table\": \"$TABLE_NAME\"}" outputfile.txt
      while [ $? != 0 ] && [ $i -lt 5 ]; do
        sleep 10
        i=$((i+1))
        aws lambda invoke --region us-east-1 --function-name qsp-protocol-node-keystore --payload "{\"assign\": true, \"table\": \"$TABLE_NAME\"}" outputfile.txt
      done
      if [ $i == 5 ] || grep -q "errorMessage" outputfile.txt ; then
        echo "Failed to get keystore info"
        exit 1
      fi
      mkdir -p /var/geth-keystore
      echo `cat outputfile.txt | jq .'Keystore | fromjson'` > /var/geth-keystore/keystore.json


container_commands:
  "40_copy_keystore":
    command: bash /tmp/copy-keystore.sh